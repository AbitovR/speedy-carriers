<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speedy Carries - Driver Payment System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: linear-gradient(135deg, #70AD47 0%, #5a9038 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        header p {
            opacity: 0.9;
            font-size: 14px;
        }
        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .upload-section h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #70AD47;
        }
        .upload-area {
            border: 2px dashed #70AD47;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f0fdf4;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        .upload-area:hover {
            border-color: #5a9038;
            background: #e6f9e0;
        }
        .upload-area.dragover {
            border-color: #70AD47;
            background: #d9f0d4;
        }
        .upload-area input {
            display: none;
        }
        .upload-area p {
            font-size: 14px;
            color: #666;
            margin: 10px 0;
        }
        .upload-button {
            background: #70AD47;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        .upload-button:hover {
            background: #5a9038;
        }
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .setting-group {
            display: flex;
            flex-direction: column;
        }
        .setting-group label {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
            color: #333;
        }
        .setting-group input, .setting-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .setting-group input:focus, .setting-group select:focus {
            outline: none;
            border-color: #70AD47;
            box-shadow: 0 0 0 2px rgba(112, 173, 71, 0.1);
        }
        .setting-group input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid #70AD47;
        }
        .summary-card h3 {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        .summary-card .amount {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }
        .trips-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .trips-section h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #70AD47;
        }
        .calc-breakdown {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #e0e0e0;
        }
        .calc-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .calc-row.bold {
            font-weight: 600;
            border-bottom: 2px solid #ddd;
        }
        .calc-row.highlight {
            background: #fffacd;
            padding: 8px;
            margin: 8px 0;
            border-radius: 4px;
        }
        .cars-list {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 13px;
        }
        .car-item {
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }
        .car-item:last-child {
            border-bottom: none;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .trip-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #70AD47;
            color: white;
        }
        .btn-primary:hover {
            background: #5a9038;
        }
        .btn-danger {
            background: #FF6B6B;
            color: white;
        }
        .btn-danger:hover {
            background: #e63946;
        }
        .error {
            background: #FFE6E6;
            border: 1px solid #FF6B6B;
            color: #c92a2a;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .success {
            background: #E6FFE6;
            border: 1px solid #70AD47;
            color: #2d6a2d;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Speedy Carries - Driver Payment System</h1>
            <p>Professional Driver Compensation & Trip Management Platform</p>
        </header>

        <div id="messages"></div>

        <div class="upload-section">
            <h2>üì§ Import Trip Report</h2>
            <div class="upload-area" id="uploadArea">
                <p>üéØ Drag and drop your SuperDispatch Trip Report (Excel or CSV)</p>
                <p style="font-size: 12px;">or</p>
                <button class="upload-button" onclick="document.getElementById('fileInput').click()">Select File</button>
                <input id="fileInput" type="file" accept=".csv,.xlsx,.xls"/>
            </div>

            <h3 style="margin-top: 20px; margin-bottom: 15px; color: #70AD47;">‚öôÔ∏è Settings</h3>
            <div class="settings-grid">
                <div class="setting-group">
                    <label>Driver Type</label>
                    <select id="driverType" onchange="updateSettings()">
                        <option value="driver">Driver (32%)</option>
                        <option value="owner">Owner Operator (90%)</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>Dispatch Fee (10% - Auto Applied)</label>
                    <input id="dispatchFee" type="text" value="10%" disabled/>
                </div>
                <div class="setting-group">
                    <label>Parking</label>
                    <input id="parking" type="number" step="0.01" value="0" onchange="updateSettings()"/>
                </div>
                <div class="setting-group">
                    <label>ELD/LogBook</label>
                    <input id="eldLogbook" type="number" step="0.01" value="0" onchange="updateSettings()"/>
                </div>
                <div class="setting-group">
                    <label>Insurance</label>
                    <input id="insurance" type="number" step="0.01" value="0" onchange="updateSettings()"/>
                </div>
                <div class="setting-group">
                    <label>Fuel</label>
                    <input id="fuel" type="number" step="0.01" value="0" onchange="updateSettings()"/>
                </div>
                <div class="setting-group">
                    <label>IFTA</label>
                    <input id="ifta" type="number" step="0.01" value="0" onchange="updateSettings()"/>
                </div>
            </div>
        </div>

        <div id="summarySection" style="display: none;">
            <div class="summary-cards" id="summaryCards"></div>
            
            <div class="trips-section" id="tripsSection">
                <h2>üìä Trip Summary</h2>
                <div id="tripsList"></div>
            </div>
        </div>

        <div id="emptyState" class="empty-state">
            <p>üëÜ Upload a SuperDispatch Trip Report to get started</p>
        </div>
    </div>

    <script>
        let tripData = null;
        let settings = {
            driverType: 'driver',
            dispatchFee: 0.10,
            parking: 0,
            eldLogbook: 0,
            insurance: 0,
            fuel: 0,
            ifta: 0
        };

        // Setup drag and drop
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        function normalizePaymentMethod(method) {
            let normalized = String(method || 'billing').toLowerCase().trim();
            if (normalized === 'cod') normalized = 'cash';
            return normalized;
        }

        function handleFile(file) {
            if (!file) return;
            const reader = new FileReader();
            
            reader.onload = (event) => {
                try {
                    if (file.name.endsWith('.csv')) {
                        parseCSV(event.target.result);
                    } else {
                        const workbook = XLSX.read(event.target.result, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const rows = XLSX.utils.sheet_to_json(worksheet);
                        parseExcelRows(rows);
                    }
                } catch (err) {
                    showMessage(`Error: ${err.message}`, 'error');
                    console.error(err);
                }
            };
            
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function parseExcelRows(rows) {
            const loads = [];
            let tripName = null;
            let tripDriver = null;

            rows.forEach(row => {
                if (!row['Load ID'] || row['Trip Name'] === 'Totals:' || !row['Total Price']) {
                    return;
                }

                if (row['Trip Name'] && !tripName) {
                    tripName = row['Trip Name'];
                }
                if (row['Trip Driver'] && !tripDriver) {
                    tripDriver = row['Trip Driver'];
                }

                const loadId = String(row['Load ID']).trim();
                const customer = String(row['Customer'] || '').trim();
                const vehicle = String(row['Vehicles'] || '').trim();
                const price = parseFloat(row['Total Price']) || 0;
                const brokerFee = parseFloat(row['Broker Fee']) || 0;
                const paymentMethod = normalizePaymentMethod(row['Method']);

                if (loadId && customer && price > 0) {
                    loads.push({
                        loadId,
                        customer,
                        vehicle,
                        price,
                        brokerFee,
                        paymentMethod
                    });
                }
            });

            if (loads.length === 0) {
                showMessage('No valid loads found in the file', 'error');
                return;
            }

            tripData = {
                tripName: tripName || 'Trip Report',
                tripDriver: tripDriver || 'Driver',
                loads: loads
            };

            showMessage(`Successfully imported ${loads.length} loads!`, 'success');
            render();
        }

        function updateSettings() {
            settings.driverType = document.getElementById('driverType').value;
            settings.parking = parseFloat(document.getElementById('parking').value) || 0;
            settings.eldLogbook = parseFloat(document.getElementById('eldLogbook').value) || 0;
            settings.insurance = parseFloat(document.getElementById('insurance').value) || 0;
            settings.fuel = parseFloat(document.getElementById('fuel').value) || 0;
            settings.ifta = parseFloat(document.getElementById('ifta').value) || 0;
            render();
        }

        function calculateSummary() {
            if (!tripData) return null;

            let totalPrice = 0;
            let totalBrokerFee = 0;
            let totalGrossBeforeDeductions = 0;
            let cashGrossBeforeDeductions = 0;
            let checkGrossBeforeDeductions = 0;
            let billingGrossBeforeDeductions = 0;

            tripData.loads.forEach(load => {
                totalPrice += load.price;
                totalBrokerFee += load.brokerFee;
                const gross = load.price - load.brokerFee;
                totalGrossBeforeDeductions += gross;

                const method = normalizePaymentMethod(load.paymentMethod);
                if (method === 'cash') {
                    cashGrossBeforeDeductions += gross;
                } else if (method === 'check' || method === 'ach') {
                    checkGrossBeforeDeductions += gross;
                } else {
                    billingGrossBeforeDeductions += gross;
                }
            });

            // Calculate 10% dispatch fee
            const dispatchFeeAmount = totalGrossBeforeDeductions * settings.dispatchFee;

            // Total expenses (dispatch fee + other expenses)
            const otherExpenses = settings.parking + settings.eldLogbook + settings.insurance + settings.fuel + settings.ifta;
            const totalExpenses = dispatchFeeAmount + otherExpenses;
            
            // Apply deductions proportionally to each payment method
            const cashShare = totalGrossBeforeDeductions > 0 ? cashGrossBeforeDeductions / totalGrossBeforeDeductions : 0;
            const checkShare = totalGrossBeforeDeductions > 0 ? checkGrossBeforeDeductions / totalGrossBeforeDeductions : 0;
            const billingShare = totalGrossBeforeDeductions > 0 ? billingGrossBeforeDeductions / totalGrossBeforeDeductions : 0;

            const cashExpenses = totalExpenses * cashShare;
            const checkExpenses = totalExpenses * checkShare;
            const billingExpenses = totalExpenses * billingShare;

            // Gross AFTER deductions
            const totalGrossAfterDeductions = totalGrossBeforeDeductions - totalExpenses;
            const cashGrossAfterDeductions = cashGrossBeforeDeductions - cashExpenses;
            const checkGrossAfterDeductions = checkGrossBeforeDeductions - checkExpenses;
            const billingGrossAfterDeductions = billingGrossBeforeDeductions - billingExpenses;

            // Driver/Owner percentage
            const percentage = settings.driverType === 'owner' ? 0.90 : 0.32;
            const driverPay = totalGrossAfterDeductions * percentage;

            return {
                totalPrice,
                totalBrokerFee,
                totalGrossBeforeDeductions,
                dispatchFeeAmount,
                otherExpenses,
                totalExpenses,
                totalGrossAfterDeductions,
                cashGrossBeforeDeductions,
                checkGrossBeforeDeductions,
                billingGrossBeforeDeductions,
                cashGrossAfterDeductions,
                checkGrossAfterDeductions,
                billingGrossAfterDeductions,
                cashExpenses,
                checkExpenses,
                billingExpenses,
                driverPay,
                percentage,
                loadCount: tripData.loads.length
            };
        }

        function showMessage(text, type) {
            const messagesDiv = document.getElementById('messages');
            const msgElement = document.createElement('div');
            msgElement.className = type;
            msgElement.textContent = text;
            messagesDiv.appendChild(msgElement);
            setTimeout(() => msgElement.remove(), 3000);
        }

        function generatePDF() {
            const summary = calculateSummary();
            if (!summary) {
                showMessage('No trip data to generate PDF', 'error');
                return;
            }

            const driverType = settings.driverType === 'owner' ? 'Owner Operator' : 'Driver';
            const percent = settings.driverType === 'owner' ? '90%' : '32%';
            const paymentLabel = settings.driverType === 'owner' ? 'OWNER OPERATOR PAY' : 'DRIVER PAY';

            const cashPay = summary.cashGrossAfterDeductions * (settings.driverType === 'owner' ? 0.90 : 0.32);
            const checkPay = summary.checkGrossAfterDeductions * (settings.driverType === 'owner' ? 0.90 : 0.32);
            const billingPay = summary.billingGrossAfterDeductions * (settings.driverType === 'owner' ? 0.90 : 0.32);

            const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <title>${tripData.tripName.replace(/\s+/g, '_')}_statement</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 40px; color: #333; }
        h1 { color: #70AD47; text-align: center; margin-bottom: 30px; font-size: 28px; }
        h3 { color: #70AD47; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        tr { border-bottom: 1px solid #eee; }
        td { padding: 8px 0; }
        td:last-child { text-align: right; }
        .total { background: #f0fdf4; color: #70AD47; font-weight: bold; padding: 20px; text-align: center; border: 2px solid #70AD47; border-radius: 8px; }
        .amount { font-weight: bold; }
        hr { border: none; border-top: 2px solid #70AD47; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>TRIP STATEMENT</h1>
    
    <div style="margin-bottom: 20px; border-bottom: 2px solid #70AD47; padding-bottom: 20px;">
        <p><strong>Trip:</strong> ${tripData.tripName}</p>
        <p><strong>Driver:</strong> ${tripData.tripDriver}</p>
        <p><strong>Type:</strong> ${driverType} (${percent})</p>
        <p><strong>Total Loads:</strong> ${summary.loadCount}</p>
        <p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>
    </div>

    <h3>INVOICE BREAKDOWN</h3>
    <table>
        <tr>
            <td><strong>Total Invoice Price</strong></td>
            <td class="amount">$${summary.totalPrice.toFixed(2)}</td>
        </tr>
        <tr>
            <td>Broker Fee</td>
            <td>-$${summary.totalBrokerFee.toFixed(2)}</td>
        </tr>
        <tr style="border-bottom: 2px solid #ddd;">
            <td><strong>Gross BEFORE Expenses</strong></td>
            <td class="amount">$${summary.totalGrossBeforeDeductions.toFixed(2)}</td>
        </tr>
    </table>

    <h3>EXPENSES (Deducted from Gross)</h3>
    <table>
        <tr>
            <td>Dispatch Fee (10%)</td>
            <td>-$${summary.dispatchFeeAmount.toFixed(2)}</td>
        </tr>
        <tr>
            <td>Parking</td>
            <td>-$${settings.parking.toFixed(2)}</td>
        </tr>
        <tr>
            <td>ELD/LogBook</td>
            <td>-$${settings.eldLogbook.toFixed(2)}</td>
        </tr>
        <tr>
            <td>Insurance</td>
            <td>-$${settings.insurance.toFixed(2)}</td>
        </tr>
        <tr>
            <td>Fuel</td>
            <td>-$${settings.fuel.toFixed(2)}</td>
        </tr>
        <tr>
            <td>IFTA</td>
            <td>-$${settings.ifta.toFixed(2)}</td>
        </tr>
        <tr style="border-bottom: 2px solid #ddd;">
            <td><strong>Total Expenses</strong></td>
            <td>-$${summary.totalExpenses.toFixed(2)}</td>
        </tr>
    </table>

    <h3>GROSS BREAKDOWN BY PAYMENT METHOD (AFTER EXPENSES)</h3>
    <table>
        <tr>
            <td>Cash (including COD)</td>
            <td>$${summary.cashGrossAfterDeductions.toFixed(2)}</td>
        </tr>
        <tr>
            <td>Check/ACH</td>
            <td>$${summary.checkGrossAfterDeductions.toFixed(2)}</td>
        </tr>
        <tr style="border-bottom: 2px solid #ddd;">
            <td>Billing/Credit</td>
            <td>$${summary.billingGrossAfterDeductions.toFixed(2)}</td>
        </tr>
        <tr>
            <td><strong>TOTAL NET GROSS</strong></td>
            <td class="amount">$${summary.totalGrossAfterDeductions.toFixed(2)}</td>
        </tr>
    </table>

    <h3>${driverType.toUpperCase()} EARNINGS (${percent} of Net Gross)</h3>
    <table>
        <tr style="border-bottom: 2px solid #ddd;">
            <td><strong>Total ${driverType} Earnings</strong></td>
            <td class="amount">$${summary.driverPay.toFixed(2)}</td>
        </tr>
    </table>

    <div class="total">
        <p style="margin: 0; font-size: 14px; color: #70AD47;">${paymentLabel}</p>
        <h2 style="margin: 10px 0; font-size: 36px; color: #70AD47;">$${summary.driverPay.toFixed(2)}</h2>
    </div>

    <h3>PAYMENT BREAKDOWN BY METHOD</h3>
    <table>
        <tr>
            <td><strong>üíµ Cash Due (includes COD)</strong></td>
            <td class="amount">$${Math.max(0, cashPay).toFixed(2)}</td>
        </tr>
        <tr>
            <td><strong>‚úì Check/ACH Due</strong></td>
            <td class="amount">$${Math.max(0, checkPay).toFixed(2)}</td>
        </tr>
        <tr>
            <td><strong>üìã Billing Due</strong></td>
            <td class="amount">$${Math.max(0, billingPay).toFixed(2)}</td>
        </tr>
    </table>
</body>
</html>
            `;

            const newWindow = window.open('', '', 'width=900,height=800');
            newWindow.document.write(htmlContent);
            newWindow.document.close();
            
            setTimeout(() => {
                newWindow.print();
            }, 250);

            showMessage('PDF window opened. Use your browser print function to save as PDF.', 'success');
        }

        function clearTrip() {
            if (confirm('Clear all loads and start over?')) {
                tripData = null;
                render();
                showMessage('Trip cleared', 'success');
            }
        }

        function render() {
            const summary = calculateSummary();
            const summarySection = document.getElementById('summarySection');
            const emptyState = document.getElementById('emptyState');

            if (!tripData || tripData.loads.length === 0) {
                summarySection.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            summarySection.style.display = 'block';
            emptyState.style.display = 'none';

            const driverType = settings.driverType === 'owner' ? 'Owner Op (90%)' : 'Driver (32%)';

            const summaryCards = document.getElementById('summaryCards');
            summaryCards.innerHTML = `
                <div class="summary-card">
                    <h3>üí∞ Total Invoice (${tripData.loads.length} loads)</h3>
                    <div class="amount">$${summary.totalPrice.toFixed(2)}</div>
                </div>
                <div class="summary-card">
                    <h3>üìã Broker Fee</h3>
                    <div class="amount">-$${summary.totalBrokerFee.toFixed(2)}</div>
                </div>
                <div class="summary-card">
                    <h3>üìä Gross (Before Expenses)</h3>
                    <div class="amount">$${summary.totalGrossBeforeDeductions.toFixed(2)}</div>
                </div>
                <div class="summary-card">
                    <h3>üí∏ Dispatch Fee (10%)</h3>
                    <div class="amount">-$${summary.dispatchFeeAmount.toFixed(2)}</div>
                </div>
                <div class="summary-card">
                    <h3>üìå Other Expenses</h3>
                    <div class="amount">-$${summary.otherExpenses.toFixed(2)}</div>
                </div>
                <div class="summary-card">
                    <h3>‚úÖ Net Gross (After Expenses)</h3>
                    <div class="amount" style="color: #70AD47;">$${summary.totalGrossAfterDeductions.toFixed(2)}</div>
                </div>
                <div class="summary-card">
                    <h3>üíº ${driverType}</h3>
                    <div class="amount">$${summary.driverPay.toFixed(2)}</div>
                </div>
            `;

            const tripsList = document.getElementById('tripsList');
            const cashPay = summary.cashGrossAfterDeductions * (settings.driverType === 'owner' ? 0.90 : 0.32);
            const checkPay = summary.checkGrossAfterDeductions * (settings.driverType === 'owner' ? 0.90 : 0.32);
            const billingPay = summary.billingGrossAfterDeductions * (settings.driverType === 'owner' ? 0.90 : 0.32);

            tripsList.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <strong style="font-size: 16px; color: #70AD47;">Trip: ${tripData.tripName}</strong>
                    <p style="color: #666; margin: 5px 0;">Driver: ${tripData.tripDriver}</p>
                </div>

                <div class="calc-breakdown">
                    <h4 style="color: #70AD47; margin-bottom: 15px;">Complete Breakdown</h4>
                    <div class="calc-row"><span>Total Invoice Price</span><span><strong>$${summary.totalPrice.toFixed(2)}</strong></span></div>
                    <div class="calc-row"><span>- Broker Fee</span><span>-$${summary.totalBrokerFee.toFixed(2)}</span></div>
                    <div class="calc-row bold"><span>Gross (Before Expenses)</span><span>$${summary.totalGrossBeforeDeductions.toFixed(2)}</span></div>
                    
                    <div style="margin: 15px 0;">
                        <div style="font-weight: 600; color: #70AD47; margin-bottom: 10px;">Expenses (Deducted from Gross):</div>
                        <div class="calc-row"><span>- Dispatch Fee (10%)</span><span>$${summary.dispatchFeeAmount.toFixed(2)}</span></div>
                        ${settings.parking > 0 ? `<div class="calc-row"><span>- Parking</span><span>$${settings.parking.toFixed(2)}</span></div>` : ''}
                        ${settings.eldLogbook > 0 ? `<div class="calc-row"><span>- ELD/LogBook</span><span>$${settings.eldLogbook.toFixed(2)}</span></div>` : ''}
                        ${settings.insurance > 0 ? `<div class="calc-row"><span>- Insurance</span><span>$${settings.insurance.toFixed(2)}</span></div>` : ''}
                        ${settings.fuel > 0 ? `<div class="calc-row"><span>- Fuel</span><span>$${settings.fuel.toFixed(2)}</span></div>` : ''}
                        ${settings.ifta > 0 ? `<div class="calc-row"><span>- IFTA</span><span>$${settings.ifta.toFixed(2)}</span></div>` : ''}
                    </div>

                    <div class="calc-row bold highlight"><span>NET GROSS (After Expenses)</span><span style="color: #70AD47;">$${summary.totalGrossAfterDeductions.toFixed(2)}</span></div>
                    <div class="calc-row"><span>√ó Driver/Owner Share (${settings.driverType === 'owner' ? '90%' : '32%'})</span><span>=</span></div>
                    <div class="calc-row bold highlight"><span style="color: #70AD47; font-weight: bold;">${settings.driverType === 'owner' ? 'OWNER OPERATOR EARNINGS' : 'DRIVER EARNINGS'}</span><span style="color: #70AD47; font-size: 18px; font-weight: bold;">$${summary.driverPay.toFixed(2)}</span></div>

                    <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #ddd;">
                        <div style="font-weight: 600; color: #70AD47; margin-bottom: 10px;">Payment Breakdown by Method:</div>
                        <div class="calc-row"><span>üíµ Cash Payment Due (incl. COD)</span><span><strong>$${Math.max(0, cashPay).toFixed(2)}</strong></span></div>
                        <div class="calc-row"><span>‚úì Check/ACH Due</span><span><strong>$${Math.max(0, checkPay).toFixed(2)}</strong></span></div>
                        <div class="calc-row"><span>üìã Billing Due</span><span><strong>$${Math.max(0, billingPay).toFixed(2)}</strong></span></div>
                    </div>

                    <div class="trip-actions" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="generatePDF()" style="flex: 1;">
                            üìÑ Generate & Print Statement
                        </button>
                        <button class="btn btn-danger" onclick="clearTrip()">
                            üóëÔ∏è Clear Trip
                        </button>
                    </div>
                </div>

                <h4 style="margin-top: 30px; color: #70AD47;">Individual Loads (${tripData.loads.length})</h4>
                <div class="cars-list">
                    ${tripData.loads.map((load, idx) => `
                        <div class="car-item">
                            <strong>${idx + 1}. ${load.vehicle}</strong>
                            <div style="color: #666; font-size: 12px; margin-top: 3px;">
                                ${load.customer} ‚Ä¢ ${load.paymentMethod.toUpperCase()} ‚Ä¢ Price: $${load.price.toFixed(2)} | Broker: -$${load.brokerFee.toFixed(2)} | Gross: $${(load.price - load.brokerFee).toFixed(2)}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
    </script>
</body>
</html>
